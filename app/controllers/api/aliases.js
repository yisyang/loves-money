// Generated by CoffeeScript 1.8.0
(function() {
  var controller, formatAlias, hmacSha1, sha1;

  hmacSha1 = require('crypto-js/hmac-sha1');

  sha1 = require('crypto-js/sha1');

  controller = {};

  controller.getIndex = function(req, res) {
    res._cc.fail('Invalid route, please use the UI at loves.money or view github source for valid requests.');
  };

  controller.getAlias = function(req, res) {
    var aliases;
    aliases = req.app.models.alias;
    aliases.findOne({
      src_name: req.params.alias
    }, function(err, alias) {
      if (err) {
        res._cc.fail('Unable to get alias', 500, null, err);
      }
      if (alias) {
        res._cc.success(formatAlias(req, alias));
      } else {
        res._cc.fail('Alias not found');
      }
    });
  };

  controller.postAlias = function(req, res) {
    var aliases, currentUser, new_alias, _ref;
    currentUser = req.app.get('user');
    aliases = req.app.models.alias;
    new_alias = {
      customer_id: currentUser.uuid,
      src_name: req.body.alias,
      dest_domain: req.body.domain,
      dest_email: req.body.email,
      customer_secret_hash: hmacSha1(req.body.secret, req.app.get('config').secret_keys.db_hash).toString()
    };
    if (!new_alias.src_name || ((_ref = new_alias.src_name) === 'abuse' || _ref === 'admin' || _ref === 'administrator' || _ref === 'billing' || _ref === 'hostmaster' || _ref === 'info' || _ref === 'postmaster' || _ref === 'ssl-admin' || _ref === 'support' || _ref === 'webmaster')) {
      res._cc.fail('Requested alias is reserved');
      return;
    }
    aliases.create(new_alias).then(function(alias) {
      req.app.models.virtual_alias.create({
        domain_id: req.app.get('config').mailserver_domain_id,
        source: new_alias.src_name + '@loves.money',
        destination: new_alias.dest_email
      }).then(function() {
        return res._cc.success(formatAlias(req, alias));
      })["catch"](function(err) {
        aliases.destroy({
          id: alias.id
        }, function() {});
        res._cc.fail('Error creating mail alias', 500, null, err);
      });
    })["catch"](function() {
      aliases.findOne().where({
        src_name: new_alias.src_name
      }).then(function(alias) {
        if (alias) {
          res._cc.fail('The alias is already registered');
          throw false;
        }
        return aliases.findOne().where({
          dest_domain: new_alias.dest_domain
        }).then(function(alias) {
          return alias;
        });
      }).then(function(alias) {
        if (alias) {
          res._cc.fail('The domain is already registered');
          throw false;
        }
        return aliases.findOne().where({
          dest_email: new_alias.dest_email
        }).then(function(alias) {
          return alias;
        });
      }).then(function(alias) {
        if (alias) {
          res._cc.fail('The email is already registered');
          throw false;
        }
      })["catch"](function(err) {
        if (err) {
          res._cc.fail('Error creating alias', 500, null, err);
        }
      });
    });
  };

  controller.deleteAlias = function(req, res) {
    var aliases, _ref;
    if (!req.body.secret) {
      return res._cc.fail('Missing parameter secret');
    }
    if (!req.params.alias || ((_ref = req.params.alias) === 'abuse' || _ref === 'admin' || _ref === 'administrator' || _ref === 'billing' || _ref === 'hostmaster' || _ref === 'info' || _ref === 'postmaster' || _ref === 'ssl-admin' || _ref === 'support' || _ref === 'webmaster')) {
      res._cc.fail('Requested alias is reserved');
      return;
    }
    aliases = req.app.models.alias;
    aliases.findOne().where({
      src_name: req.params.alias
    }).then(function(alias) {
      var currentUser, customer_secret_hash;
      if (!alias) {
        res._cc.fail('Alias not found');
        throw false;
      }
      currentUser = req.app.get('user');
      if (currentUser.uuid !== alias.customer_id && !currentUser.isAdmin) {
        res._cc.fail('You are not the owner of this alias!', 401);
        return;
      }
      customer_secret_hash = hmacSha1(req.body.secret, req.app.get('config').secret_keys.db_hash).toString();
      if (customer_secret_hash !== alias.customer_secret_hash) {
        res._cc.fail('Incorrect secret', 401);
        throw false;
      }
      req.app.models.virtual_alias.destroy({
        domain_id: req.app.get('config').mailserver_domain_id,
        destination: alias.dest_email,
        custom: true
      }).then(function() {
        return aliases.destroy({
          id: alias.id
        });
      }).then(function() {
        res._cc.success();
      })["catch"](function(err) {
        res._cc.fail('Unable to delete alias', 500, null, err);
      });
    })["catch"](function(err) {
      if (err) {
        res._cc.fail('Unable to get alias', 500, null, err);
      }
    });
  };

  controller.deleteAll = function(req, res) {
    var aliases, currentUser;
    if (req.app.get('config').env === !'development') {
      res._cc.fail('Forbidden', 403);
      return;
    }
    currentUser = req.app.get('user');
    if (!currentUser.isAdmin) {
      res._cc.fail('Not authorized', 401);
      return;
    }
    aliases = req.app.models.alias;
    aliases.query('TRUNCATE TABLE aliases').then(function() {
      return req.app.models.virtual_alias.destroy({
        custom: true
      });
    }).then(function() {
      res._cc.success();
    })["catch"](function(err) {
      if (err) {
        res._cc.fail('Unable to truncate aliases', 500, null, err);
      }
    });
  };

  formatAlias = function(req, alias) {
    var result;
    return result = {
      customer_id: alias.customer_id,
      alias: alias.src_name,
      domain: alias.dest_domain,
      email: alias.dest_email
    };
  };

  module.exports = controller;

}).call(this);

//# sourceMappingURL=aliases.js.map
